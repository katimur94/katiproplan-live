<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiTom Site Manager Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#0f172a',
                        card: '#1e293b',
                        accent: '#38bdf8',
                        text: '#f1f5f9',
                        dim: '#94a3b8'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #38bdf8; }
        
        details > summary { list-style: none; cursor: pointer; transition: all 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary:hover { background-color: rgba(255,255,255,0.05); }
        
        .rotate-icon { transition: transform 0.2s; }
        details[open] > summary .rotate-icon { transform: rotate(90deg); color: #38bdf8; }

        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .hide { display: none !important; }
        
        .highlight { background-color: rgba(56, 189, 248, 0.2); border-radius: 4px; color: #fff; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="glass p-8 rounded-2xl shadow-2xl w-full max-w-md text-center border-t-4 border-accent">
            <div class="mb-6">
                <i class="fa-solid fa-robot text-5xl text-accent mb-4"></i>
                <h1 class="text-3xl font-bold tracking-wider">DITOM <span class="text-accent">CLOUD</span></h1>
                <p class="text-dim text-sm mt-2">Zugang gesch√ºtzt</p>
            </div>
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-dim uppercase ml-1">Roboter System</label>
                    <select id="system-select" class="w-full p-3 bg-slate-900 border border-slate-700 rounded-lg text-white outline-none focus:border-accent"><option>Lade...</option></select>
                </div>
                <div>
                    <label class="text-xs font-bold text-dim uppercase ml-1">Passwort</label>
                    <input type="password" id="password-input" class="w-full p-3 bg-slate-900 border border-slate-700 rounded-lg text-white outline-none focus:border-accent">
                </div>
                <button onclick="attemptLogin()" class="w-full bg-accent hover:bg-sky-400 text-slate-900 font-bold py-3 rounded-lg mt-4 shadow-lg shadow-accent/20">LOGIN</button>
                <p id="error-msg" class="text-red-400 text-sm mt-2 text-center hide">Falsches Passwort</p>
            </div>
        </div>
    </div>

    <div id="app-content" class="flex-1 flex flex-col hide">
        
        <header class="glass sticky top-0 z-40 border-b border-slate-700 shadow-lg">
            <div class="container mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-network-wired text-accent text-xl"></i>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">DITOM <span class="text-accent">MANAGER</span></h1>
                        <p class="text-[10px] text-dim" id="header-sys-info">Nicht verbunden</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden md:block text-right">
                        <p class="text-xs text-dim">Letzter Sync</p>
                        <p class="text-sm font-mono text-emerald-400" id="last-update-time">--:--</p>
                    </div>
                    <button onclick="logout()" class="p-2 hover:text-red-400 transition"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </header>

        <div class="container mx-auto p-4">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="glass p-4 rounded-xl border-l-4 border-accent relative overflow-hidden">
                    <p class="text-dim text-[10px] uppercase font-bold tracking-widest">Stutzen Saniert</p>
                    <div class="flex items-end justify-between mt-2">
                        <span id="stat-stz" class="text-3xl font-bold text-white">0</span>
                        <i class="fa-solid fa-ring text-accent/10 text-5xl absolute -right-2 -bottom-2"></i>
                    </div>
                </div>
                <div class="glass p-4 rounded-xl border-l-4 border-purple-500 relative overflow-hidden">
                    <p class="text-dim text-[10px] uppercase font-bold tracking-widest">K-Liner / Muffen</p>
                    <div class="flex items-end justify-between mt-2">
                        <span id="stat-kl" class="text-3xl font-bold text-white">0</span>
                        <i class="fa-solid fa-bandage text-purple-500/10 text-5xl absolute -right-2 -bottom-2"></i>
                    </div>
                </div>
                <div class="glass p-4 rounded-xl border-l-4 border-emerald-500 relative overflow-hidden">
                    <p class="text-dim text-[10px] uppercase font-bold tracking-widest">Projekte</p>
                    <div class="flex items-end justify-between mt-2">
                        <span id="stat-proj" class="text-3xl font-bold text-white">0</span>
                        <i class="fa-solid fa-folder-tree text-emerald-500/10 text-5xl absolute -right-2 -bottom-2"></i>
                    </div>
                </div>
                <div class="glass p-4 rounded-xl border-l-4 border-amber-500 relative overflow-hidden">
                    <p class="text-dim text-[10px] uppercase font-bold tracking-widest">Andere Sanierungen</p>
                    <div class="flex items-end justify-between mt-2">
                        <span id="stat-other" class="text-3xl font-bold text-white">0</span>
                        <i class="fa-solid fa-tools text-amber-500/10 text-5xl absolute -right-2 -bottom-2"></i>
                    </div>
                </div>
            </div>

            <div class="glass p-3 rounded-xl mb-6 flex flex-col md:flex-row gap-3 items-center sticky top-20 z-30 shadow-2xl border border-slate-700">
                <div class="relative w-full md:flex-1">
                    <i class="fa-solid fa-search absolute left-3 top-3.5 text-gray-500"></i>
                    <input type="text" id="search-input" onkeyup="filterData()" placeholder="üîç Suche nach Haltung, Stra√üe oder Projekt..." 
                           class="w-full bg-slate-900 border border-slate-700 text-white text-sm rounded-lg focus:border-accent block pl-10 p-2.5 outline-none transition">
                </div>
                
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="year-filter" onchange="filterData()" class="bg-slate-900 border border-slate-700 text-white text-sm rounded-lg p-2.5 outline-none cursor-pointer hover:border-dim">
                        <option value="all">üìÖ Alle Jahre</option>
                    </select>
                    
                    <select id="sort-order" onchange="filterData()" class="bg-slate-900 border border-slate-700 text-white text-sm rounded-lg p-2.5 outline-none cursor-pointer hover:border-dim">
                        <option value="desc">‚¨áÔ∏è Neueste</option>
                        <option value="asc">‚¨ÜÔ∏è √Ñlteste</option>
                        <option value="az">üî§ A-Z Name</option>
                    </select>
                </div>
            </div>

            <div id="results-container" class="space-y-4 pb-20"></div>
        </div>
    </div>

    <script>
        const DATA_WRAPPER = /*JSON_START*/ {} /*JSON_END*/;
        let FLATTENED_DATA = [];

        document.addEventListener('DOMContentLoaded', () => {
            const sel = document.getElementById('system-select');
            sel.innerHTML = "";
            if (Object.keys(DATA_WRAPPER).length === 0) sel.innerHTML = "<option>Keine Daten</option>";
            Object.keys(DATA_WRAPPER).forEach(sys => {
                const opt = document.createElement('option');
                opt.value = sys; opt.innerText = sys; sel.appendChild(opt);
            });
            const s = localStorage.getItem('ditom_sys'), p = localStorage.getItem('ditom_pass');
            if(s && p && DATA_WRAPPER[s]) { 
                document.getElementById('system-select').value = s; 
                document.getElementById('password-input').value = p; 
                attemptLogin(); 
            }
        });

        function attemptLogin() {
            const sys = document.getElementById('system-select').value;
            const pass = document.getElementById('password-input').value;
            if (DATA_WRAPPER[sys] && String(DATA_WRAPPER[sys].password) === String(pass)) {
                localStorage.setItem('ditom_sys', sys); localStorage.setItem('ditom_pass', pass);
                initApp(sys);
                document.getElementById('login-modal').classList.add('hide');
                document.getElementById('app-content').classList.remove('hide');
            } else {
                document.getElementById('error-msg').classList.remove('hide');
            }
        }

        function logout() { localStorage.clear(); location.reload(); }

        function initApp(sysName) {
            const data = DATA_WRAPPER[sysName];
            document.getElementById('header-sys-info').innerText = sysName;
            document.getElementById('last-update-time').innerText = "Stand: " + data.last_update;

            // --- BERECHNUNG DER STATISTIKEN (CLIENT-SIDE) ---
            let cStutzen = 0;
            let cLiner = 0;
            let cOther = 0;
            
            // Wir iterieren durch die Daten um "Andere" exakt zu berechnen
            const projects = data.data.projects || {};
            const totalProj = Object.keys(projects).length;

            Object.values(projects).forEach(pData => {
                Object.values(pData.streets).forEach(street => {
                    Object.values(street).forEach(haltung => {
                        Object.keys(haltung).forEach(dName => {
                            const dmg = haltung[dName];
                            // Nur wenn es saniert ist ("nach san" existiert)
                            if (dmg.isSaniert) {
                                const nameLower = dName.toLowerCase();
                                if (nameLower.includes("stutzen")) {
                                    cStutzen++;
                                } else if (nameLower.includes("liner") || nameLower.includes("muffe")) {
                                    cLiner++;
                                } else {
                                    // Alles was saniert ist, aber kein Stutzen/Liner ist
                                    cOther++; 
                                }
                            }
                        });
                    });
                });
            });

            animateNum("stat-stz", cStutzen);
            animateNum("stat-kl", cLiner);
            animateNum("stat-proj", totalProj);
            animateNum("stat-other", cOther); // Hier ist dein neuer Wert!

            // DATEN VORBEREITEN
            prepareData(projects);

            // JAHRE FILTER
            const years = new Set();
            FLATTENED_DATA.forEach(p => { if(p.date !== "0000-00-00") years.add(p.date.split('-')[0]); });
            const ySel = document.getElementById('year-filter');
            Array.from(years).sort().reverse().forEach(y => {
                const opt = document.createElement('option'); opt.value = y; opt.innerText = "Jahr " + y; ySel.appendChild(opt);
            });

            filterData();
        }

        function prepareData(projects) {
            FLATTENED_DATA = [];
            Object.keys(projects).forEach(pName => {
                const pData = projects[pName];
                let maxDate = "0000-00-00";
                try {
                    Object.values(pData.streets).forEach(str => 
                        Object.values(str).forEach(hal => 
                            Object.values(hal).forEach(dmg => { if(dmg.dates) dmg.dates.forEach(d => {if(d>maxDate)maxDate=d}) })
                        )
                    );
                } catch(e){}
                FLATTENED_DATA.push({ name: pName, data: pData, date: maxDate, searchStr: (pName + JSON.stringify(pData)).toLowerCase() });
            });
        }

        function filterData() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const year = document.getElementById('year-filter').value;
            const sort = document.getElementById('sort-order').value;
            
            let filtered = FLATTENED_DATA.filter(p => {
                if (search && !p.searchStr.includes(search)) return false;
                if (year !== 'all' && !p.date.startsWith(year)) return false;
                return true;
            });

            filtered.sort((a, b) => {
                if(sort === 'desc') return b.date.localeCompare(a.date);
                if(sort === 'asc') return a.date.localeCompare(b.date);
                if(sort === 'az') return a.name.localeCompare(b.name);
                return 0;
            });

            renderList(filtered, search);
        }

        function renderList(items, searchTerm) {
            const con = document.getElementById('results-container'); con.innerHTML = '';
            if (items.length === 0) { con.innerHTML = '<div class="text-center text-dim mt-10">Keine Ergebnisse</div>'; return; }

            items.forEach(item => {
                const shouldExpand = searchTerm && searchTerm.length > 0;
                const card = document.createElement('details');
                card.className = "glass rounded-xl overflow-hidden border-l-4 border-l-slate-600 group";
                if(shouldExpand) card.setAttribute("open", "");

                const dateDisp = item.date !== "0000-00-00" ? item.date.split('-').reverse().join('.') : "";
                
                let html = '<div class="p-4 bg-slate-900/50 space-y-3 border-t border-slate-700">';
                const streets = item.data.streets;
                Object.keys(streets).sort().forEach(sName => {
                    const matchStreet = searchTerm && sName.toLowerCase().includes(searchTerm);
                    const openStreet = matchStreet ? "open" : "";
                    
                    html += `<details ${openStreet} class="pl-2 border-l border-slate-700 ml-1"><summary class="flex items-center gap-2 py-1 hover:text-accent"><i class="fa-solid fa-chevron-right rotate-icon text-xs"></i> <i class="fa-solid fa-road text-dim"></i> <b>${highlightText(sName, searchTerm)}</b></summary><div class="pl-6 mt-2 space-y-2">`;
                    
                    const haltungen = streets[sName];
                    Object.keys(haltungen).sort().forEach(hName => {
                        const matchHaltung = searchTerm && hName.toLowerCase().includes(searchTerm);
                        const openHaltung = matchHaltung ? "open" : "";

                        html += `<details ${openHaltung}><summary class="flex items-center gap-2 py-1 hover:text-white text-dim"><i class="fa-solid fa-chevron-right rotate-icon text-xs"></i> <i class="fa-solid fa-circle-notch text-xs"></i> ${highlightText(hName, searchTerm)}</summary><div class="pl-4 mt-2 grid gap-2">`;
                        const damages = haltungen[hName];
                        Object.keys(damages).sort().forEach(dName => {
                            const dmg = damages[dName];
                            const badge = dmg.isSaniert ? "border-emerald-500/50 text-emerald-400 bg-emerald-900/10" : "border-amber-500/50 text-amber-400 bg-amber-900/10";
                            let files = "";
                            dmg.files.forEach(f => files += `<div class="flex justify-between text-[10px] text-dim bg-black/20 p-1 px-2 rounded mt-1"><span>${f.name}</span><span>${f.date}</span></div>`);
                            html += `<div class="p-2 rounded border ${badge} text-xs"><div class="font-bold uppercase mb-1 flex items-center gap-2"><i class="fa-solid fa-wrench"></i> ${highlightText(dName, searchTerm)}</div>${files}</div>`;
                        });
                        html += `</div></details>`;
                    });
                    html += `</div></details>`;
                });
                html += '</div>';

                card.innerHTML = `<summary class="p-4 flex items-center justify-between bg-slate-800/50 hover:bg-slate-800"><div class="flex items-center gap-3"><i class="fa-solid fa-chevron-right rotate-icon text-dim text-xs"></i><i class="fa-solid fa-folder text-accent text-xl"></i><div><h3 class="font-bold text-white">${highlightText(item.name, searchTerm)}</h3><div class="text-xs text-dim">${dateDisp} | ${item.data.stutzenSaniert} Stutzen</div></div></div></summary>${html}`;
                con.appendChild(card);
            });
        }

        function highlightText(text, term) {
            if(!term) return text;
            const regex = new RegExp(`(${term})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function animateNum(id, end) {
            const obj = document.getElementById(id);
            let start = 0;
            if(end === 0) { obj.innerText = "0"; return; }
            const duration = 1000;
            const step = Math.ceil(end / (duration / 16));
            let timer = setInterval(() => {
                start += step;
                if(start >= end) { start = end; clearInterval(timer); }
                obj.innerText = start;
            }, 16);
        }
    </script>
</body>
</html>